name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r27c

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        cache-read-only: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master' }}

    - name: Grant execute permission for scripts
      run: |
        chmod +x gradlew
        chmod +x scripts/*.sh
        chmod +x .github/scripts/*.sh

    - name: Install Native Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential ninja-build

    - name: Build Native Libraries
      run: |
        # Build Whisper JNI
        ./scripts/build_whisper_linux.sh
        # Build SDCPP JNI (needed for Video test, even if we skip it, to ensure build passes)
        ./scripts/build_sdcpp_linux.sh
        # Build SmolLM (llama.cpp) JNI
        ./scripts/build_smollm_linux.sh

    - name: Download Test Models
      run: .github/scripts/download_models.sh

    - name: Run Unit Tests
      run: |
        ./gradlew :llmedge:testDebugUnitTest \
          --exclude-tests "*LinuxE2ETest" \
          --exclude-tests "*IntegrationTest" \
          --exclude-tests "io.aatricks.llmedge.ImageGenerationTest" \
          --exclude-tests "io.aatricks.llmedge.VideoGenerationTest" \
          --exclude-tests "io.aatricks.llmedge.StableDiffusionTxt2VidTest" \
          --exclude-tests "io.aatricks.llmedge.StableDiffusionTxt2ImgTest" \
          --exclude-tests "io.aatricks.llmedge.VideoI2VAndLoraE2ETest" \
          --exclude-tests "io.aatricks.llmedge.VideoGenerationSequentialE2ETest" \
          --exclude-tests "io.aatricks.llmedge.VideoGenerationHQTest" \
          --exclude-tests "io.aatricks.llmedge.VideoGenerationExportTest" \
          --exclude-tests "io.aatricks.llmedge.SamplerSchedulerGifTest" \
          --exclude-tests "io.aatricks.llmedge.FullPhonePathCatTest" \
          --exclude-tests "io.aatricks.llmedge.BarkTTSTest" \
          --exclude-tests "io.aatricks.llmedge.WhisperTest"

    - name: Run E2E Tests (Whisper)
      env:
        LLMEDGE_TEST_WHISPER_MODEL_PATH: ${{ github.workspace }}/models/ggml-tiny.en.bin
        LLMEDGE_BUILD_WHISPER_LIB_PATH: ${{ github.workspace }}/llmedge/build/native/linux-x86_64/libwhisper_jni.so
      run: |
        # Explicitly run the Whisper E2E test
        ./gradlew :llmedge:testDebugUnitTest --tests "*WhisperLinuxE2ETest"

    - name: Run E2E Tests (SmolLM Text)
      env:
        LLMEDGE_TEST_TEXT_MODEL_PATH: ${{ github.workspace }}/models/SmolLM2-135M-Instruct-Q8_0.gguf
      run: |
        ./scripts/run_text_e2e.sh

    - name: Build release AAR
      run: ./gradlew :llmedge:assembleRelease

    - name: Upload AAR
      uses: actions/upload-artifact@v4
      with:
        name: llmedge-release
        path: llmedge/build/outputs/aar/*.aar
